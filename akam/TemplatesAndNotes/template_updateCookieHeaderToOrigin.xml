<match:request.method result="false" value="AKAMAI_TRANSLATE AKAMAI_PURGE">
  <match:request.type value="CLIENT_REQ">
  <!--
    If incoming request does not have bby_cbc_lb cookie, then compute the cookie based on the ORIGIN value
    Modify the outgoing Cookie header to include the cookie value as well, so that parent and origin sees the cookie.
  -->
    <assign:variable>
      <name>FINAL_COOKIE</name>
      <value>bby_si_lb=%(LB_COOKIE)</value>
    </assign:variable>
    <match:request.header name="Cookie" result="true">
      <assign:extract-value>
        <location>Client_Request_Header</location>
        <location-id>Cookie</location-id>
        <variable-name>ORIGINAL_COOKIE</variable-name>
      </assign:extract-value>
      <assign:variable>
        <name>FINAL_COOKIE</name>
        <value>bby_si_lb=%(LB_COOKIE);%(ORIGINAL_COOKIE)</value>
        <transform>
          <substitute>
            <regex>(;$)</regex>
            <replacement/>
          </substitute>
        </transform>
      </assign:variable>
    </match:request.header>
    <match:metadata-stage value="forward-request">
      <match:variable name="FINAL_COOKIE" result="true">
        <edgeservices:modify-outgoing-request.remove-header>
          <status>on</status>
          <name>Cookie</name>
        </edgeservices:modify-outgoing-request.remove-header>
        <edgeservices:modify-outgoing-request.add-header>
          <status>on</status>
          <name>Cookie</name>
          <value>%(FINAL_COOKIE)</value>
        </edgeservices:modify-outgoing-request.add-header>
      </match:variable>
    </match:metadata-stage>
  </match:request.type>
</match:request.method>
