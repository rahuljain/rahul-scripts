<!--
  Extract value of bby_cbc_lb from request cookie (recieved from browser).
-->
<assign:extract-value>
  <location>Cookie</location>
  <location-id>bby_cbc_lb</location-id>
  <variable-name>BBY_CBC_LB_COOKIE</variable-name>
</assign:extract-value>


<match:request.method result="false" value="AKAMAI_TRANSLATE AKAMAI_PURGE">
  <match:request.type value="CLIENT_REQ">
    <!-- 
      Set Cookie on the browser if not being set by the origin.
    -->
    <match:metadata-stage value="forward-response">
      <assign:extract-value>
        <location>Set_Cookie</location>
        <location-id>bby_cbc_lb</location-id>
        <variable-name>ORIGIN_BBY_CBC_LB_COOKIE</variable-name>
      </assign:extract-value>
    </match:metadata-stage>
    <match:variable name="ORIGIN_BBY_CBC_LB_COOKIE" result="false" value="ct-browse-e ct-browse-w" value-case="off">
      <match:metadata-stage value="client-response">
        <edgeservices:cookie.set-fixed name="bby_cbc_lb">
          <status>on</status>
          <domain>.bestbuy.com</domain>
          <name>bby_cbc_lb</name>
          <value>%(BBY_CBC_LB_COOKIE)</value>
          <path>/</path>
          <expires>10m</expires>
        </edgeservices:cookie.set-fixed>
      </match:metadata-stage>
    </match:variable>
  </match:request.type>
</match:request.method>
